/*@preserve mastersoft-address-magento*/
define(["jquery","jquery/ui","harmony","domReady!"],function($){"use strict";console.info("jquery version "+$.fn.jquery),$.ui?console.info("jquery ui is loaded - version "+$.ui.version):console.warn("jquery ui is NOT loaded");var LOGO_SRC="https://s3-ap-southeast-2.amazonaws.com/common.mastersoftgroup.com/styles/images/mastersoft/mastersoft-clear-logo.png",configs,addressForm="",line1,line2,city,region,postcode,shippingAddressPrefix="shippingAddress",billingAddressPrefixBase="billingAddress",billingAddressMOPrefix="billingAddresscheckmo",billingAddressPOPrefix="billingAddresspurchaseorder",billingAddressBTPrefix="billingAddressbanktransfer",billingAddressCODPrefix="billingAddresscashondelivery",billingAddressBraintreePrefix="billingAddressbraintree",billingAddressPrefix=billingAddressPrefixBase,customerAddressForm="#form-validate",billingAddressChk='[name="billing-address-same-as-shipping"]',country="country_id",timeoutVar,selectedCountry;function wait(){window.Harmony&&$('[name="'+country+'"]').length?(clearTimeout(timeoutVar),init(),country&&$(getFieldSelector(addressForm,country))&&$(getFieldSelector(addressForm,country)).val()&&main(selectedCountry=$(getFieldSelector(addressForm,country)).val())):(timeoutVar=setTimeout(wait,1e3),console.info("Waiting for knockout and Harmony"))}function getFieldSelector(e,o){return void 0===o&&console.warn("Encountered undefined field for "+addressForm),o.startsWith("#")?o:e.startsWith("#")?e+' [name="'+o+'"]':'div[name="'+e+"."+o.replace("[",".").replace("]","")+'"] [name="'+o+'"]'}function getAdminConfigs(){var map={username:void 0,password:void 0,url:void 0,AU:{locale:Harmony.AUSTRALIA,sot:void 0,featureOptions:{}},NZ:{locale:Harmony.NEW_ZEALAND,sot:void 0,featureOptions:{}}},key=$("#keyConfig").val().trim(),url=$("#urlConfig").val().trim(),options=$("#optionsConfig").val().trim(),optionsAu=$("#optionsAuConfig").val().trim(),optionsNz=$("#optionsNzConfig").val().trim(),i,username,password,value,obj;return void 0!==key&&key&&0<key.indexOf(":")&&(i=key.indexOf(":"),username=key.substring(0,i),password=key.substring(i+1,key.length),username)&&password&&(map.username=username,map.password=password,void 0!==url&&url&&(map.url=url),void 0!==options&&options&&(obj=eval("(["+options+"])")[0],Object.keys(obj).forEach(function(e){value=obj[e],"sot"!=e&&(map.AU.featureOptions[e]=value,map.NZ.featureOptions[e]=value)})),void 0!==optionsAu&&optionsAu&&(obj=eval("(["+optionsAu+"])")[0],Object.keys(obj).forEach(function(e){value=obj[e],"sot"==e?map.AU.sot=value:map.AU.featureOptions[e]=value})),void 0!==optionsNz)&&optionsNz&&(obj=eval("(["+optionsNz+"])")[0],Object.keys(obj).forEach(function(e){value=obj[e],"sot"==e?map.NZ.sot=value:map.NZ.featureOptions[e]=value})),console.info("URL: "+url+", Options: "+options+", AU Options: "+optionsAu+", NZ Options: "+optionsNz),map}function init(){populateFields(),(configs=getAdminConfigs()).AU.regions={ACT:"Australian Capital Territory",NSW:"New South Wales",NT:"Northern Territory",QLD:"Queensland",SA:"South Australia",TAS:"Tasmania",VIC:"Victoria",WA:"Western Australia"}}function populateFields(){$('[name="street[0]"]').length?(line1="street[0]",line2="street[1]",$('div[name="'+shippingAddressPrefix+'"]').length?addressForm=shippingAddressPrefix:$('div[name="'+billingAddressPrefix+'"]').length&&(addressForm=billingAddressPrefix)):$("#street_1").length&&(line1="#street_1",line2="#street_2",addressForm=customerAddressForm),city="city",region="region",postcode="postcode",refreshFields()}function getRegionField(){var e=$(getFieldSelector(addressForm,"region_id")+" option").last().val();return void 0!==e&&e?"region_id":"region"}function refreshFields(){region=getRegionField()}function onChangeCountry(e,o){(selectedCountry=$(getFieldSelector(addressForm=e,o)).val())&&void 0!==selectedCountry&&(refreshFields(),$(getFieldSelector(e,line1)).val(""),$(getFieldSelector(e,line2)).val(""),$(getFieldSelector(e,city)).val(""),$(getFieldSelector(e,region)).val(""),$(getFieldSelector(e,postcode)).val(""),main(selectedCountry))}function main(e){var o,t,r,i,n=void 0,e=(e&&configs&&!isEmpty(configs)&&void 0!==configs[e]&&configs[e]&&(i=configs[e.toUpperCase()].locale,o=configs[e.toUpperCase()].sot,n=configs[e.toUpperCase()].featureOptions),configs.username),s=configs.password,d=configs.url;function l(e,o){$(e).val(function(e,o){for(var i=[],t=0;t<e.length;t++)void 0!==e[t]&&e[t]&&e[t].trim()&&i.push(e[t]);return i.join(o)}([o.building,o.subdwelling,o.postal,o.street],", ")),$(e).trigger("keyup"),$(getFieldSelector(addressForm,city)).val((e=o,(i=t)==Harmony.AUSTRALIA?e.locality:i==Harmony.NEW_ZEALAND?e.suburb||e.townCity:void 0)),$(getFieldSelector(addressForm,city)).trigger("keyup"),i=o;var i,e=(e=t)==Harmony.AUSTRALIA?configs.AU.regions[i.state.toUpperCase()]:e==Harmony.NEW_ZEALAND?i.townCity.toUpperCase():void 0;"region_id"==region?($(getFieldSelector(addressForm,region)+" option:contains("+e+")").attr("selected","selected"),$(getFieldSelector(addressForm,region)).trigger("change")):"region"==region&&($(getFieldSelector(addressForm,region)).val(e),$(getFieldSelector(addressForm,region)).trigger("keyup")),$(getFieldSelector(addressForm,postcode)).val(o.postcode),$(getFieldSelector(addressForm,postcode)).trigger("keyup")}void 0!==i&&i&&void 0!==o&&o&&void 0!==e&&e&&void 0!==s&&s?($(getFieldSelector(addressForm,line1)).autocomplete({disabled:!1}),e=e,s=s,t=i,r=o,i=n,Harmony.useEnv(d),Harmony.init(e,s,t),Harmony.useProtocol(Harmony.JSONP),Harmony.useFeatureOptions(i),$(getFieldSelector(addressForm,line1)).autocomplete({minLength:3,delay:500,source:function(e,i){Harmony.address({fullAddress:e.term},r,function(e){var o;e.status==Harmony.SUCCESS?(o=$.map(e.payload,function(e){return{label:e.fullAddress,building:e.buildingName,subdwelling:e.subdwelling,street:e.streetNumber+" "+e.street,postal:e.postal,locality:e.locality,state:e.state,suburb:e.suburb,townCity:e.townCity,postcode:e.postcode}}),i(o)):e.messages&&0<e.messages.length?console.info(e.messages[0]):console.info("Request is not successful. Please contact admin.")})},open:function(e,o){var i=$("<img />",{src:LOGO_SRC,alt:"",align:"right"});i.click(function(){$(e.target).autocomplete("close")}),$(this).autocomplete("widget").append(i),$(this).autocomplete("widget").zIndex(4e3)},focus:function(e,o){e.preventDefault()},select:function(e,o){e.preventDefault(),Harmony.transaction(r),refreshFields(),l(this,o.item)}})):$(getFieldSelector(addressForm,line1)).autocomplete({disabled:!0})}function printout(e,o){console.log(o+"=");var r=0;$.each(e,function(e,o){if("Object"==typeof o||o instanceof Object)printout(o,e);else{r+=2;for(var i="",t=0;t<r;t++)i+=" ";console.log(i+e+": "+o),r-=2}})}function isEmpty(e){for(var o in e)return!e.hasOwnProperty(o);return 1}wait(),$(document).on("click",".action-show-popup",function(){populateFields(),(selectedCountry=$(getFieldSelector(addressForm,country)).val())&&void 0!==selectedCountry&&main(selectedCountry)}),$(document).on("change",".payment-method._active",function(){var e=$('.payment-method._active input[name="payment[method]"]').attr("id");addressForm=billingAddressPrefix=billingAddressPrefixBase+e}),$(document).on("change",getFieldSelector(shippingAddressPrefix,country),function(){(selectedCountry=$(getFieldSelector(addressForm=shippingAddressPrefix,country)).val())&&void 0!==selectedCountry&&(refreshFields(),$(getFieldSelector(shippingAddressPrefix,line1)).val(""),$(getFieldSelector(shippingAddressPrefix,line2)).val(""),$(getFieldSelector(shippingAddressPrefix,city)).val(""),$(getFieldSelector(shippingAddressPrefix,region)).val(""),$(getFieldSelector(shippingAddressPrefix,postcode)).val(""),main(selectedCountry))}),$(document).on("change",getFieldSelector(billingAddressCODPrefix,country),function(){onChangeCountry(billingAddressCODPrefix,country)}),$(document).on("change",getFieldSelector(billingAddressBTPrefix,country),function(){onChangeCountry(billingAddressBTPrefix,country)}),$(document).on("change",getFieldSelector(billingAddressPOPrefix,country),function(){onChangeCountry(billingAddressPOPrefix,country)}),$(document).on("change",getFieldSelector(billingAddressMOPrefix,country),function(){onChangeCountry(billingAddressMOPrefix,country)}),$(document).on("change",getFieldSelector(billingAddressBraintreePrefix,country),function(){onChangeCountry(billingAddressBraintreePrefix,country)}),$(document).on("change",getFieldSelector(customerAddressForm,country),function(){(selectedCountry=$(getFieldSelector(addressForm=customerAddressForm,country)).val())&&void 0!==selectedCountry&&(refreshFields(),$(getFieldSelector(customerAddressForm,line1)).val(""),$(getFieldSelector(customerAddressForm,line2)).val(""),$(getFieldSelector(customerAddressForm,city)).val(""),$(getFieldSelector(customerAddressForm,region)).val(""),$(getFieldSelector(customerAddressForm,postcode)).val(""),main(selectedCountry))}),$(document).on("change",billingAddressChk,function(){$(billingAddressChk).prop("checked")?main(void 0):(selectedCountry=$(getFieldSelector(addressForm=billingAddressPrefix,country)).val())&&void 0!==selectedCountry&&main(selectedCountry)}),$(window).bind("hashchange",function(){var e=window.location.pathname,o=window.location.hash;"/checkout/"==e&&"#payment"==o?addressForm=billingAddressPrefix:"/checkout/"==e&&"#shipping"==o&&(addressForm=shippingAddressPrefix),(selectedCountry=$(getFieldSelector(addressForm,country)).val())&&void 0!==selectedCountry&&main(selectedCountry)})});